'use client';

import { useEffect, useRef, useState, useImperativeHandle, forwardRef } from 'react';
import { Plugin } from 'molstar/lib/mol-plugin-ui/plugin';
import { DefaultPluginUISpec } from 'molstar/lib/mol-plugin-ui/spec';
import { Asset } from 'molstar/lib/mol-util/assets';
import 'molstar/build/viewer/molstar.css';

// è§†å›¾ç±»å‹
export type ViewType = 'cartoon' | 'surface' | 'ball-and-stick';

// è°ƒè¯•ä¿¡æ¯ç±»å‹
export interface DebugInfo {
  lastLoadSource: string;
  lastError: string | null;
  workerStatus: 'pending' | 'loaded' | 'failed';
  wasmStatus: 'pending' | 'loaded' | 'failed';
  structureLoaded: boolean;
  logMessages: string[];
}

// æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•
export interface MolStarViewerRef {
  loadStructure: (file: File) => Promise<void>;
  loadFromPdbId: (pdbId: string) => Promise<void>;
  setView: (view: ViewType) => void;
  exportImage: () => Promise<void>;
  toggleFullscreen: () => void;
  getDebugInfo: () => DebugInfo;
}

interface MolStarViewerProps {
  className?: string;
  onViewChange?: (view: ViewType) => void;
}

const MolStarViewer = forwardRef<MolStarViewerRef, MolStarViewerProps>(
  ({ className = '', onViewChange }, ref) => {
    const pluginRef = useRef<any>(null);
    const [currentView, setCurrentView] = useState<ViewType>('cartoon');
    const [plugin, setPlugin] = useState<any>(null);
    const [isInitialized, setIsInitialized] = useState(false);

    // è°ƒè¯•ä¿¡æ¯
    const [debugInfo, setDebugInfo] = useState<DebugInfo>({
      lastLoadSource: 'None',
      lastError: null,
      workerStatus: 'pending',
      wasmStatus: 'pending',
      structureLoaded: false,
      logMessages: [],
    });

    const addLog = (message: string) => {
      const timestamp = new Date().toLocaleTimeString();
      setDebugInfo(prev => ({
        ...prev,
        logMessages: [...prev.logMessages, `[${timestamp}] ${message}`].slice(-20),
      }));
      console.log(`[MolStarViewer] ${message}`);
    };

    // åˆå§‹åŒ– Mol* Plugin
    useEffect(() => {
      let mounted = true;

      const initPlugin = async () => {
        try {
          addLog('å¼€å§‹åˆå§‹åŒ– Mol* Plugin...');

          // åŠ¨æ€å¯¼å…¥æ‰€éœ€æ¨¡å—
          const { PluginContext } = await import('molstar/lib/mol-plugin/context');
          addLog('PluginContext æ¨¡å—åŠ è½½æˆåŠŸ');

          // åˆ›å»º plugin å®ä¾‹ï¼Œä½¿ç”¨å®˜æ–¹ UI Spec
          const spec = DefaultPluginUISpec();
          const newPlugin = new PluginContext(spec);

          addLog('Plugin å®ä¾‹åˆ›å»ºæˆåŠŸ');

          // åˆå§‹åŒ– plugin
          await newPlugin.init();
          addLog('Plugin åˆå§‹åŒ–å®Œæˆ');

          if (mounted) {
            pluginRef.current = newPlugin;
            setPlugin(newPlugin);
            setIsInitialized(true);

            // æ£€æµ‹ worker çŠ¶æ€
            setDebugInfo(prev => ({ ...prev, workerStatus: 'loaded' }));
            addLog('Worker åŠ è½½æˆåŠŸï¼ŒMol* å‡†å¤‡å°±ç»ª');
          }
        } catch (error) {
          const errorMsg = error instanceof Error ? error.message : String(error);
          addLog(`åˆå§‹åŒ–å¤±è´¥: ${errorMsg}`);
          setDebugInfo(prev => ({
            ...prev,
            lastError: errorMsg,
            workerStatus: 'failed',
          }));
        }
      };

      initPlugin();

      return () => {
        mounted = false;
        // æ¸…ç†
        if (pluginRef.current) {
          pluginRef.current.dispose();
          pluginRef.current = null;
        }
      };
    }, []);

    // æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
    useImperativeHandle(ref, () => ({
      loadStructure: async (file: File) => {
        if (!pluginRef.current) {
          addLog('é”™è¯¯: Plugin æœªåˆå§‹åŒ–');
          throw new Error('Plugin not initialized');
        }

        addLog(`å¼€å§‹åŠ è½½æ–‡ä»¶: ${file.name} (${file.size} bytes)`);
        setDebugInfo(prev => ({ ...prev, lastLoadSource: file.name }));

        try {
          // è¯»å–æ–‡ä»¶å†…å®¹
          const data = await file.arrayBuffer();
          const fileData = new Uint8Array(data);

          // åˆ¤æ–­æ–‡ä»¶æ ¼å¼
          const isCif = file.name.endsWith('.cif') || file.name.endsWith('.mmcif') || file.name.endsWith('.bcif');
          const format = isCif ? 'mmcif' : 'pdb';
          const isBinary = file.name.endsWith('.bcif');

          addLog(`æ–‡ä»¶è¯»å–å®Œæˆ (${data.byteLength} bytes), æ ¼å¼: ${format}, äºŒè¿›åˆ¶: ${isBinary}`);

          // åˆ›å»º blob URL
          const blob = new Blob([fileData], { type: isBinary ? 'application/octet-stream' : 'text/plain' });
          const blobUrl = URL.createObjectURL(blob);

          // ä½¿ç”¨ Mol* çš„ download API åŠ è½½ blob URL
          await pluginRef.current.builders.data.download({
            url: blobUrl,
            format: format as any,
            isBinary: isBinary,
          });

          // æ¸…ç† blob URL
          URL.revokeObjectURL(blobUrl);

          addLog('ç»“æ„åŠ è½½æˆåŠŸï¼');

          // èšç„¦åˆ°ç»“æ„
          const canvas3d = pluginRef.current.canvas3d;
          if (canvas3d) {
            await canvas3d.camera.reset();
            addLog('ç›¸æœºé‡ç½®å®Œæˆï¼Œç»“æ„å·²èšç„¦');
          }

          setDebugInfo(prev => ({ ...prev, structureLoaded: true, lastError: null }));
        } catch (error) {
          const errorMsg = error instanceof Error ? error.message : String(error);
          addLog(`ç»“æ„åŠ è½½å¤±è´¥: ${errorMsg}`);
          console.error('åŠ è½½é”™è¯¯è¯¦æƒ…:', error);
          setDebugInfo(prev => ({ ...prev, lastError: errorMsg, structureLoaded: false }));
          throw error;
        }
      },

      loadFromPdbId: async (pdbId: string) => {
        if (!pluginRef.current) {
          addLog('é”™è¯¯: Plugin æœªåˆå§‹åŒ–');
          throw new Error('Plugin not initialized');
        }

        const upperPdbId = pdbId.toUpperCase().trim();
        addLog(`å¼€å§‹ä» RCSB åŠ è½½: ${upperPdbId}`);
        setDebugInfo(prev => ({ ...prev, lastLoadSource: `PDB: ${upperPdbId}` }));

        try {
          // ä» RCSB ä¸‹è½½ mmCIF æ ¼å¼
          const url = `https://files.rcsb.org/download/${upperPdbId}.cif`;
          addLog(`è¯·æ±‚ URL: ${url}`);

          // ä½¿ç”¨ Mol* çš„ download API
          await pluginRef.current.builders.data.download({
            url: Asset.Url(url),
            format: 'mmcif',
            isBinary: false,
          });

          addLog(`PDB ${upperPdbId} åŠ è½½æˆåŠŸï¼`);

          // èšç„¦åˆ°ç»“æ„
          const canvas3d = pluginRef.current.canvas3d;
          if (canvas3d) {
            await canvas3d.camera.reset();
            addLog('ç›¸æœºé‡ç½®å®Œæˆï¼Œç»“æ„å·²èšç„¦');
          }

          setDebugInfo(prev => ({ ...prev, structureLoaded: true, lastError: null }));
        } catch (error) {
          const errorMsg = error instanceof Error ? error.message : String(error);
          addLog(`PDB åŠ è½½å¤±è´¥: ${errorMsg}`);
          console.error('PDB åŠ è½½é”™è¯¯è¯¦æƒ…:', error);
          setDebugInfo(prev => ({ ...prev, lastError: errorMsg, structureLoaded: false }));
          throw error;
        }
      },

      setView: (view: ViewType) => {
        if (!pluginRef.current) return;
        setCurrentView(view);
        onViewChange?.(view);
        addLog(`åˆ‡æ¢è§†å›¾: ${view}`);
        // TODO: è§†å›¾åˆ‡æ¢é€»è¾‘
      },

      exportImage: async () => {
        if (!pluginRef.current) return;

        try {
          const canvas = pluginRef.current.canvas3d?.ctx.canvas;
          if (!canvas) {
            addLog('å¯¼å‡ºå¤±è´¥: æ— æ³•è·å– canvas');
            return;
          }

          canvas.toBlob((blob: Blob | null) => {
            if (blob) {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `molstar-export-${Date.now()}.png`;
              a.click();
              URL.revokeObjectURL(url);
              addLog('å›¾ç‰‡å¯¼å‡ºæˆåŠŸ');
            }
          }, 'image/png');
        } catch (error) {
          const errorMsg = error instanceof Error ? error.message : String(error);
          addLog(`å¯¼å‡ºå¤±è´¥: ${errorMsg}`);
        }
      },

      toggleFullscreen: () => {
        const viewerContainer = document.querySelector('.msp-plugin');
        if (!viewerContainer) return;

        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          viewerContainer.requestFullscreen();
        }
      },

      getDebugInfo: () => debugInfo,
    }));

    // å¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
    if (!isInitialized || !plugin) {
      return (
        <div className="w-full h-full bg-white flex flex-col items-center justify-center">
          <div className="text-lg text-gray-600 mb-2">æ­£åœ¨åŠ è½½ Mol* Viewer...</div>
          <div className="text-sm text-gray-400">åˆå§‹åŒ– 3D å¼•æ“ä¸­ï¼Œè¯·ç¨å€™</div>
          {debugInfo.lastError && (
            <div className="mt-4 text-sm text-red-500 max-w-md text-center">
              åˆå§‹åŒ–é”™è¯¯: {debugInfo.lastError}
            </div>
          )}
        </div>
      );
    }

    // æ¸²æŸ“ Mol* Pluginï¼ˆå®˜æ–¹å®Œæ•´ UIï¼‰
    return (
      <div className={`relative w-full h-full bg-white ${className}`}>
        {/* Mol* Plugin ç»„ä»¶ - å®˜æ–¹å®Œæ•´ UI */}
        <Plugin plugin={plugin} />

        {/* Debug é¢æ¿ */}
        <div className="absolute bottom-4 right-4 z-50">
          <details className="bg-slate-900/95 text-white rounded-lg shadow-xl border border-cyan-500/30">
            <summary className="px-3 py-2 cursor-pointer text-sm font-medium hover:bg-slate-800/80 rounded-t-lg">
              ğŸ”§ Debug é¢æ¿
            </summary>
            <div className="p-3 text-xs max-w-md max-h-80 overflow-y-auto">
              <div className="space-y-2">
                <div>
                  <span className="text-cyan-400">æœ€ååŠ è½½æ¥æº:</span>
                  <span className="ml-2">{debugInfo.lastLoadSource}</span>
                </div>
                <div>
                  <span className="text-cyan-400">Worker çŠ¶æ€:</span>
                  <span className={`ml-2 ${
                    debugInfo.workerStatus === 'loaded' ? 'text-green-400' :
                    debugInfo.workerStatus === 'failed' ? 'text-red-400' :
                    'text-yellow-400'
                  }`}>
                    {debugInfo.workerStatus}
                  </span>
                </div>
                <div>
                  <span className="text-cyan-400">WASM çŠ¶æ€:</span>
                  <span className={`ml-2 ${
                    debugInfo.wasmStatus === 'loaded' ? 'text-green-400' :
                    debugInfo.wasmStatus === 'failed' ? 'text-red-400' :
                    'text-yellow-400'
                  }`}>
                    {debugInfo.wasmStatus}
                  </span>
                </div>
                <div>
                  <span className="text-cyan-400">ç»“æ„å·²åŠ è½½:</span>
                  <span className={`ml-2 ${debugInfo.structureLoaded ? 'text-green-400' : 'text-gray-400'}`}>
                    {debugInfo.structureLoaded ? 'æ˜¯' : 'å¦'}
                  </span>
                </div>
                {debugInfo.lastError && (
                  <div>
                    <span className="text-red-400">æœ€åé”™è¯¯:</span>
                    <div className="mt-1 p-2 bg-red-900/30 rounded text-red-300 break-words">
                      {debugInfo.lastError}
                    </div>
                  </div>
                )}
                <div>
                  <span className="text-cyan-400">æ—¥å¿—:</span>
                  <div className="mt-1 p-2 bg-slate-800 rounded max-h-40 overflow-y-auto font-mono">
                    {debugInfo.logMessages.length === 0 ? (
                      <span className="text-gray-500">æ— æ—¥å¿—</span>
                    ) : (
                      debugInfo.logMessages.map((msg, i) => (
                        <div key={i} className="text-gray-300">{msg}</div>
                      ))
                    )}
                  </div>
                </div>
                <div className="pt-2 border-t border-slate-700">
                  <div className="text-cyan-400 mb-1">è‡ªæ£€æ¸…å•:</div>
                  <ul className="text-gray-300 space-y-1 ml-4">
                    <li>âœ“ DevTools Network ä¸­ molstar.css åº”ä¸º 200</li>
                    <li>âœ“ DevTools Network ä¸­ worker.js åº”ä¸º 200</li>
                    <li>âœ“ ä¸Šä¼  PDB åæ—¥å¿—åº”æ˜¾ç¤º"ç»“æ„åŠ è½½æˆåŠŸ"</li>
                    <li>âœ“ å¦‚æœåŠ è½½å¤±è´¥ï¼ŒæŸ¥çœ‹"æœ€åé”™è¯¯"å­—æ®µ</li>
                  </ul>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>
    );
  }
);

MolStarViewer.displayName = 'MolStarViewer';

export default MolStarViewer;
